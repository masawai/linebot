AWSTemplateFormatVersion: "2010-09-09"

Description: Template generated by rain

Parameters:
  CommonNameParameter:
    Type: String

Resources:
  MyPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Path: /
      ManagedPolicyName: !Sub ${CommonNameParameter}_codebuild_policy
      PolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          Effect: Allow
          Action: 
            - "logs:CreateLogGroup"
            - "logs:CreateLogStream"
            - "logs:PutLogEvents"
            - "s3:PutObject"
            - "s3:GetObject"
            - "s3:GetObjectVersion"
            - "s3:GetBucketAcl"
            - "s3:GetBucketLocation"
            - "codecommit:GitPull"
            - "codebuild:CreateReportGroup"
            - "codebuild:CreateReport"
            - "codebuild:UpdateReport"
            - "codebuild:BatchPutTestCases"
            - "codebuild:BatchPutCodeCoverages"
          Resource: "*"
  MyRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codebuild.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AWSLambda_FullAccess
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPowerUser
        - !Ref MyPolicy
      RoleName: !Sub ${CommonNameParameter}_codebuild_role
      Tags:
        - Key: Owner
          Value: Masaya
  
  MyProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        EncryptionDisabled: false 
        Location: !ImportValue CodeBuildOutputBucketName
        Name: !Sub CommonNameParameter
        NamespaceType: NONE
        OverrideArtifactName: false
        Packaging: NONE
        Path: ""
        Type: S3
      BadgeEnabled: false 
      Cache: 
        Type: NO_CACHE
      ConcurrentBuildLimit: 1 
      EncryptionKey: !Sub arn:aws:kms:${AWS::Region}:${AWS::AccountId}:alias/aws/s3
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        EnvironmentVariables: 
          - Name: REPOSITORY_NAME
            Type: PLAINTEXT
            Value: !Sub ${CommonNameParameter}
        Image: aws/codebuild/amazonlinux2-x86_64-standard:3.0-21.04.23
        ImagePullCredentialsType: CODEBUILD 
        PrivilegedMode: true 
        Type: LINUX_CONTAINER
      LogsConfig: 
        CloudWatchLogs: 
          Status: ENABLED
        S3Logs: 
          EncryptionDisabled: false 
          Status: DISABLED
      Name: !Sub ${CommonNameParameter}
      QueuedTimeoutInMinutes: 480
      ServiceRole: !GetAtt MyRole.Arn
      Source:
        GitCloneDepth: 1 
        GitSubmodulesConfig: 
          FetchSubmodules: false
        InsecureSsl: false 
        Location: 
          !ImportValue 
            Fn::Sub: ${CommonNameParameter}RepositoryCloneUrlHttp
        Type: CODECOMMIT
      Tags:
        - Key: Owner
          Value: Masaya
      TimeoutInMinutes: 60
      
Outputs:
  MyProjectArn:
    Value: !GetAtt MyProject.Arn
  MyProjectName:
    Value: !Ref MyProject
    Export:
      Name: !Sub ${CommonNameParameter}ProjectName

