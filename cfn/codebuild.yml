AWSTemplateFormatVersion: "2010-09-09"

Description: Template generated by rain

Parameters:
  ProjectNameParameter:
    Type: String

Resources:
  LinebotPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Path: /
      ManagedPolicyName: CodeBuildBasePolicy
      PolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          Effect: Allow
          Action: 
            - "logs:CreateLogGroup"
            - "logs:CreateLogStream"
            - "logs:PutLogEvents"
            - "s3:PutObject"
            - "s3:GetObject"
            - "s3:GetObjectVersion"
            - "s3:GetBucketAcl"
            - "s3:GetBucketLocation"
            - "codecommit:GitPull"
            - "codebuild:CreateReportGroup"
            - "codebuild:CreateReport"
            - "codebuild:UpdateReport"
            - "codebuild:BatchPutTestCases"
            - "codebuild:BatchPutCodeCoverages"
          Resource: "*"
  LinebotRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codebuild.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AWSLambda_FullAccess
        - !Ref LinebotPolicy
      RoleName: !Sub ${ProjectNameParameter}_codebuild_role
      Tags:
        - Key: Owner
          Value: Masaya
  
  LinebotProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        EncryptionDisabled: false 
        Location: !ImportValue CodeBuildOutputBucketName
        Name: !Sub ProjectNameParameter
        NamespaceType: NONE
        OverrideArtifactName: false
        Packaging: NONE
        Path: ""
        Type: S3
      BadgeEnabled: false 
      Cache: 
        Type: NO_CACHE
      ConcurrentBuildLimit: 1 
      EncryptionKey: !Sub arn:aws:kms:${AWS::Region}:${AWS::AccountId}:alias/aws/s3
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-x86_64-standard:3.0-21.04.23
        ImagePullCredentialsType: CODEBUILD 
        PrivilegedMode: false 
        Type: LINUX_CONTAINER
      LogsConfig: 
        CloudWatchLogs: 
          Status: ENABLED
        S3Logs: 
          EncryptionDisabled: false 
          Status: DISABLED
      Name: !Sub ${ProjectNameParameter}
      QueuedTimeoutInMinutes: 480
      ServiceRole: !GetAtt LinebotRole.Arn
      Source:
        GitCloneDepth: 1 
        GitSubmodulesConfig: 
          FetchSubmodules: false
        InsecureSsl: false 
        Location: !ImportValue LinebotRepositoryCloneUrlHttp
        Type: CODECOMMIT
      Tags:
        - Key: Owner
          Value: Masaya
      TimeoutInMinutes: 60
      
Outputs:
  LinebotProjectArn:
    Value: !GetAtt LinebotProject.Arn

